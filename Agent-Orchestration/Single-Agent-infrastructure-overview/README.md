# Letta AI Scan Workflow

This repository implements an automated workflow for scanning applications with the Letta AI agent. The workflow leverages Kubernetes custom resources to generate, apply, and manage scans, as well as to retrieve and process scan results.

## Table of Contents

- [Overview of the Workflow](#overview-of-the-workflow)
- [User Request](#user-request)
- [Generate the Scan CRD](#generate-the-scan-crd)
- [Apply the CRD](#apply-the-crd)
- [Store & Retrieve Results](#store--retrieve-results)
- [Return Results](#return-results)
- [Sample Code](#sample-code)
  - [Scan CRD Generation](#scan-crd-generation)
  - [Applying the CRD](#applying-the-crd)
  - [Polling for Scan Completion](#polling-for-scan-completion)
  - [Retrieving Findings from MinIO](#retrieving-findings-from-minio)
- [Letta Agent RBAC](#letta-agent-rbac)

## Overview of the Workflow

The workflow is divided into the following key steps:

1. **User Request:** A user submits a scan request (e.g., "Scan the WordPress app for vulnerabilities") to the Letta AI agent.
2. **Generate the Scan CRD:** The AI agent utilizes a fine-tuned model (DeepSeek R1) to generate a structured CRD in YAML/JSON that defines the scan.
3. **Apply the CRD:** The agent uses the Kubernetes Python client to apply the CRD, which the SCB operator then picks up to create and execute the necessary Kubernetes Jobs.
4. **Store & Retrieve Results:** The SCB operator stores the scan findings in a built-in MinIO instance. The agent can poll the CRD for status updates or directly retrieve the findings via S3-compatible APIs.
5. **Return Results:** After processing the findings, the Letta AI agent presents a summary or recommendation to the user.

## User Request

A user sends a request such as:  
`"Scan the WordPress app for vulnerabilities"`  
to the Letta AI agent running in a pod.

## Generate the Scan CRD

The Letta AI agent generates a structured CRD that defines the scan parameters. An example CRD might look like this:

```yaml
apiVersion: "execution.securecodebox.io/v1"
kind: Scan
metadata:
  name: "ai-scan-wordpress"
  namespace: scanners
spec:
  scanType: "nmap"
  parameters:
    - "-sV"
    - "-p-"
    - "wordpress.pentest.svc.cluster.local"
```
# Apply the CRD
The Letta agent applies the CRD using the Kubernetes Python client. Once applied, the SCB operator automatically detects the new CRD, creates the necessary Kubernetes Jobs, and runs the scan.

Store & Retrieve Results
Storage: Scan findings are stored in the SCB operator's built-in MinIO instance.
Retrieval: The Letta agent can either:
Poll the CRD for status updates.
Retrieve the findings directly from MinIO using S3-compatible APIs (e.g., boto3).
Return Results
After retrieving the scan results, the Letta AI agent processes the findings and presents a summary or recommendations to the user.

# Sample Code
# Scan CRD Generation
Below is an example of a Scan CRD generated by CyberExpert:


``` 
apiVersion: "execution.securecodebox.io/v1"
kind: Scan
metadata:
  name: "ai-scan-wordpress"
  namespace: scanners
spec:
  scanType: "nmap"
  parameters:
    - "-sV"
    - "-p-"
    - "wordpress.pentest.svc.cluster.local"

```

# Applying the CRD
Apply the CRD using the Kubernetes Python client:

``` 
from kubernetes import client, config
import yaml

# Load the in-cluster configuration (assuming Letta is running inside Kubernetes)
config.load_incluster_config()

# Define the CRD YAML as a string (this would be generated by your AI model)
crd_yaml = """
apiVersion: "execution.securecodebox.io/v1"
kind: Scan
metadata:
  name: "ai-scan-wordpress"
  namespace: "scanners"
spec:
  scanType: "nmap"
  parameters:
    - "-sV"
    - "-p-"
    - "wordpress.pentest.svc.cluster.local"
"""

# Parse the YAML into a Python dictionary
scan_crd = yaml.safe_load(crd_yaml)

# Use the CustomObjectsApi to create the CRD
api = client.CustomObjectsApi()
response = api.create_namespaced_custom_object(
    group="execution.securecodebox.io",
    version="v1",
    namespace="scanners",
    plural="scans",
    body=scan_crd
)

print(f"Scan CRD created: {response['metadata']['name']}")


```

# Polling for Scan Completion
Poll the CRD status to check when the scan is complete:

``` 
import time

while True:
    scan_status = api.get_namespaced_custom_object_status(
        group="execution.securecodebox.io",
        version="v1",
        namespace="scanners",
        plural="scans",
        name="ai-scan-wordpress"  # must match the metadata.name used earlier
    )
    
    state = scan_status.get("status", {}).get("state", "")
    print(f"Current Scan Status: {state}")
    
    if state.lower() == "done":
        print("Scan completed!")
        break
    time.sleep(10)  # Poll every 10 seconds

```

# Retrieving Findings from MinIO
Retrieve scan findings stored in MinIO using boto3:
``` 
import boto3

# Configure the S3 client for MinIO
s3 = boto3.client(
    's3',
    endpoint_url='http://minio-service.scanners.svc.cluster.local:9000',  # adjust based on your cluster DNS
    aws_access_key_id='YOUR_MINIO_ACCESS_KEY',
    aws_secret_access_key='YOUR_MINIO_SECRET_KEY',
    region_name='us-east-1'  # can be any value if not used
)

# Assume the scan findings are stored in a specific bucket, e.g., "scans-findings"
bucket_name = "scans-findings"
object_key = "ai-scan-wordpress/results.json"  # example path/key

# Download the scan findings file
response = s3.get_object(Bucket=bucket_name, Key=object_key)
findings_content = response['Body'].read().decode('utf-8')

print("Scan Findings:")
print(findings_content)

```

# Letta Agent RBAC
Define RBAC policies to ensure the Letta agent has the necessary permissions:

``` 
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: letta-crd-role
  namespace: scanners
rules:
- apiGroups: ["execution.securecodebox.io"]
  resources: ["scans", "scans/status", "findings"]
  verbs: ["create", "get", "list", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: letta-crd-binding
  namespace: scanners
subjects:
- kind: ServiceAccount
  name: letta-sa  # Your Letta pod's service account
  namespace: scanners
roleRef:
  kind: Role
  name: letta-crd-role
  apiGroup: rbac.authorization.k8s.io

```

